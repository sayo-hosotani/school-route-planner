# Route Planner

OpenStreetMapを使った経路プランニングアプリケーション（フロントエンドのみ）。

## 特徴

- スタート・ゴール・中継地点を地図上に配置
- Valhalla APIによる道路沿い経路の自動生成（フロントエンドから直接呼び出し）
- ポイントごとのコメント追加機能
- バックエンド不要のシンプルな構成

## 画面モード

### 通常モード（View Mode）

**目的**: 経路の閲覧

| 機能 | 説明 |
|------|------|
| 地図閲覧 | 移動・ズーム |
| ポイント表示 | コメントを吹き出し（Tooltip）で常時表示 |
| サイドバー操作 | ポイントクリック→地図中心に移動＋ハイライト（3秒間） |

### 編集モード（Edit Mode）

**目的**: ポイントと経路の編集

| 機能 | 説明 |
|------|------|
| ポイント追加 | 地図クリックで追加 |
| ポイント移動 | ドラッグで移動 |
| ポイント編集 | クリックでモーダル（種別変更・コメント・削除） |
| コメント編集 | サイドバーでインライン編集 |
| 順序変更 | 中継地点の↑↓ボタン |
| 自動経路生成 | ポイント追加・移動時にValhalla API呼び出し |
| 全クリア | 全ポイント削除 |

## ポイント種別の自動判定

ポイントは追加順に基づいて種別が自動判定される：

| 順番 | 種別 |
|------|------|
| 1番目 | スタート |
| 2番目 | ゴール |
| 3番目以降 | 中継地点（ゴールの直前に挿入） |

**追加の流れ:**
```
1. スタート追加 → [スタート]
2. ゴール追加   → [スタート, ゴール]
3. 中継地点追加 → [スタート, 中継地点1, ゴール]
4. さらに追加   → [スタート, 中継地点1, 中継地点2, ゴール]
```

このルールにより「スタートとゴールを最初に決めて、その後に経由地を追加する」という自然な操作が可能。

**手動変更**: 編集モードでポイントをクリック→モーダルで種別変更可能。

## コメント機能

### 表示箇所
- サイドバーのポイント一覧
- 地図上の吹き出し（通常モード）

## UI配置

### サイドバー（左側パネル）

```
┌─────────────────────────────────────┐
│ [通常モード] [編集モード]           │
├─────────────────────────────────────┤
│ 【編集モード時】                    │
│ ・全ポイントをクリア                │
├─────────────────────────────────────┤
│ 現在のポイント一覧:                 │
│ 1. 🟢 スタート                      │
│ 2. 🔴 中継地点1 [↑][↓]             │
│ 3. 🔴 中継地点2 ← 次はここ         │
│ 4. 🔵 ゴール                        │
└─────────────────────────────────────┘
```

### 地図コントロール

| 位置 | コントロール |
|------|-------------|
| 左下 | Attribution（出典表示） |
| 右上 | ZoomControl |
| 右下 | CoordinateDisplay + ScaleControl |

## 操作フロー

### 経路作成（編集モード）

1. 編集モードに切り替え
2. 地図クリックでポイント追加
   - 1番目→スタート、2番目→ゴール、3番目以降→中継地点
   - 追加時に自動で経路生成
3. ポイントクリックでモーダル編集（コメント・種別変更）
4. ドラッグで位置調整（終了時に経路再生成）
5. ↑↓ボタンで中継地点の順序変更
6. 通常モードに戻る

### 経路閲覧（通常モード）

1. 通常モードで起動
2. 地図にポイントと経路が表示
3. ポイント上にコメントが吹き出しで表示

## 経路生成の条件

- 最低2ポイント必要（スタート + ゴール）
- スタートとゴールが1つずつ存在
- 中継地点は0個以上
- Valhalla APIエラー時は直線接続にフォールバック

## 地図表示

| 項目 | 値 |
|------|-----|
| 地図ライブラリ | React Leaflet |
| タイルプロバイダー | 国土地理院 地理院タイル（標準地図） |
| タイルURL | `https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png` |
| 初期位置 | 東京（35.6812, 139.7671）、ズーム13 |

## 技術スタック

- **フロントエンド**: React + TypeScript + Vite + React Leaflet
- **経路計算**: Valhalla (Docker) - フロントエンドから直接呼び出し
- **地図タイル**: 国土地理院 地理院タイル

## セットアップ

### 1. Docker環境の起動

Valhallaを起動:

```bash
docker-compose up -d valhalla
```

**初回起動時の注意:**
- Valhallaは初回起動時に地図データのダウンロードとタイル生成を行います
- 関東地方のデータで約10-20分かかります
- `docker-compose logs -f valhalla`でログを確認できます

### 2. 依存パッケージのインストール

```bash
npm install
```

### 3. アプリケーションの起動

```bash
npm run dev
```

- **フロントエンド**: http://localhost:5173
- **Valhalla API**: http://localhost:8002

## 開発コマンド

```bash
# 開発サーバー起動
npm run dev

# テスト実行
npm run test

# リンター・フォーマッター
npm run lint
npm run format
```

## ドキュメント

| ファイル | 内容 |
|---------|------|
| [CLAUDE.md](./CLAUDE.md) | 開発者向けクイックリファレンス |
| [ARCHITECTURE.md](./ARCHITECTURE.md) | アーキテクチャ詳細 |
| [DEVELOPMENT.md](./DEVELOPMENT.md) | 開発ガイド |
| [TODO.md](./TODO.md) | 未完了タスク |

## トラブルシューティング

### Valhallaが起動しない

1. ログを確認: `docker-compose logs -f valhalla`
2. ディスク容量を確認（最低5GB以上の空き容量が必要）
3. ボリュームを削除して再起動: `docker-compose down -v && docker-compose up -d valhalla`

### 経路生成がエラーになる

1. Valhallaのステータス確認: `curl http://localhost:8002/status`
2. タイル生成が完了しているか確認
3. 指定した座標が地図データの範囲内か確認（関東地方外の場合はエラー）

### CORSエラーが発生する

フロントエンドからValhallaへの直接リクエストでCORSエラーが発生する場合:
1. Valhallaの設定でCORSを許可
2. または開発時はViteのプロキシ設定を使用
