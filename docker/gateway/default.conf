map $http_origin $cors_origin {
  default "";
  "https://sayo-hosotani.github.io" $http_origin;
  # 開発用に必要なら追加
  # "http://localhost:5173" $http_origin;
}

server {
  listen 8080;

  location = /status {
    return 200 "ok\n";
  }

  location / {

    # upstream が CORS ヘッダ返すなら衝突回避（任意）
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Expose-Headers;

    # セキュリティヘッダ
    add_header Content-Security-Policy "default-src 'none'" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Frame-Options "DENY" always;

    # Preflight
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Methods "POST, OPTIONS" always;

      # ★ここが肝：ブラウザが要求したヘッダをそのまま許可
      add_header Access-Control-Allow-Headers $http_access_control_request_headers always;

      add_header Access-Control-Max-Age 86400 always;
      add_header Vary "Origin, Access-Control-Request-Method, Access-Control-Request-Headers" always;

      # セキュリティヘッダ（if ブロック内では再宣言が必要）
      add_header Content-Security-Policy "default-src 'none'" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header X-Frame-Options "DENY" always;

      return 204;
    }

    # 通常リクエスト
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
    add_header Vary "Origin" always;

    proxy_pass https://school-route-planner-valhalla-api.fly.dev;

    proxy_ssl_server_name on;
    proxy_ssl_name school-route-planner-valhalla-api.fly.dev;
    proxy_set_header Host school-route-planner-valhalla-api.fly.dev;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
