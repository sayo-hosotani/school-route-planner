# TODO リスト

## 現在の状態
- ✅ プロジェクト構成（モノレポ）
- ✅ フロントエンド: 地図表示、サンプル経路表示
- ✅ バックエンド: 経路保存・読み込みAPI（route.txt）
- ✅ フロントエンド: API連携、保存・読み込みボタン実装
- ✅ フロントエンド: 編集モード完全実装（モード切り替え、ポイント追加・編集・削除、ドラッグ移動、直線経路接続）

## 次にやるべきこと

### 1. フロントエンド: API連携（優先度: 高）
- [x] APIクライアント作成（`packages/frontend/src/api/route-api.ts`）
  - POST /routes（経路保存）
  - GET /routes（経路読み込み）
- [x] 保存ボタンの実装
  - 現在の経路データをバックエンドに送信
- [x] 読み込みボタンの実装
  - 保存済み経路をバックエンドから取得して表示

### 2. フロントエンド: 編集モード実装（優先度: 高）✅ 完了
- [x] モード管理（useState）
  - 通常モード / 編集モード の切り替え
- [x] 左側パネル作成（`Sidebar.tsx`）
  - モード切り替えボタン
  - 保存/読み込みボタン（通常モード）
  - ポイント一覧表示（固定表示、ハイライト、連番付き）
  - 中継地点の並び替えボタン（↑↓ボタン、編集モード時のみ）
  - 通常モードでは空の追加欄を非表示
- [x] 地図クリックでポイント追加（`MapClickHandler.tsx`）
  - 編集モード時のみ有効
  - 新ルール: 1番目=スタート、2番目=ゴール、3番目以降=中継地点（ゴールの直前に挿入）
- [x] ポイント編集モーダル（`PointEditModal.tsx`）
  - コメント入力
  - 種別変更
  - 削除ボタン
- [x] ポイントのドラッグ移動（`PointMarker.tsx`更新）
  - react-leafletのMarkerにdraggable属性を追加
  - ドラッグ終了時の処理
- [x] 経路の直線接続（`updateRouteLine`関数）
  - ポイント追加・移動・削除時に自動で経路を直線接続
- [x] メッセージ表示（`MessageDisplay.tsx`）
  - 画面中央上部に固定表示
  - サイドバーから独立してUIのずれを防止

### 3. 経路生成機能（優先度: 中）← 次のステップ
- [ ] Valhalla API連携の調査
  - ローカルで動かすか、外部サービスを使うか決定
  - Docker Composeでの起動方法検討
- [ ] バックエンド: Valhalla APIへのリクエスト処理
  - `packages/backend/src/services/route-service.ts` 作成
  - ポイント配列からValhalla APIリクエスト生成
  - レスポンスをGeoJSON形式に変換
- [ ] フロントエンド: 自動経路生成
  - ポイント追加時に経路生成APIを呼び出し（TODO箇所あり）
  - ポイント移動終了時に経路生成APIを呼び出し（TODO箇所あり）
  - 直線接続から道路沿い経路に変更

### 4. データベース対応（優先度: 中）
- [ ] PostgreSQL環境構築
  - Docker Composeでの起動設定
- [ ] マイグレーション作成
  - usersテーブル
  - pointsテーブル
  - routesテーブル
  - commentsテーブル（または pointsテーブルに含める）
- [ ] Kysely設定
  - データベース接続
  - 型生成
- [ ] Repository層実装
  - route-repository.ts
  - point-repository.ts
- [ ] Service層実装
  - route-service.ts（既存のファイル保存処理をDB保存に変更）
- [ ] ルート更新
  - route.txtではなくDBに保存・読み込み

### 5. 認証機能（優先度: 低）
- [ ] ユーザー登録・ログイン画面
- [ ] JWT認証実装
  - @fastify/jwtプラグイン導入
  - ログイン/登録エンドポイント
- [ ] フロントエンド: 認証状態管理
  - トークンの保存（localStorage）
  - APIリクエストにトークン付与
- [ ] 認証が必要なエンドポイントに認証チェック追加

### 6. UI/UX改善（優先度: 低）
- [ ] スタイリング
  - 左側パネルのデザイン
  - ボタンのスタイル統一
  - レスポンシブ対応
- [ ] エラーハンドリング
  - API呼び出しエラー時の表示
  - バリデーションエラーの表示
- [ ] ローディング表示
  - 経路生成中のインジケーター
  - データ読み込み中のスケルトン表示
- [ ] 地図画像ダウンロード機能
  - 表示中の経路をPNG画像としてダウンロード
  - Scale以外のコントロール（Zoom、Coordinate、Attribution等）を非表示にして画像化
  - leaflet-imageやhtml2canvasなどのライブラリを検討

### 7. テスト（優先度: 低）
- [ ] バックエンドのテスト
  - ルートのテスト
  - サービス層のテスト
- [ ] フロントエンドのテスト
  - コンポーネントのテスト

### 8. 本番環境準備（優先度: 低）
- [ ] 本番ビルドスクリプト作成
  - フロントエンドビルド → バックエンドpublicにコピー
- [ ] 静的ファイル配信設定
  - @fastify/staticプラグイン導入
  - publicディレクトリの配信設定
- [ ] 環境変数管理
  - .env.example作成
  - 本番用の環境変数設定
- [ ] デプロイ手順書作成

## メモ
- CLAUDE.mdに設計が詳しく記載されている（実装済み機能も更新済み）
- サンプルデータは`packages/frontend/src/data/sample-route.ts`
- バックエンドAPI: http://localhost:3000
- フロントエンド: http://localhost:5173
- 開発時の起動: `npm run dev:all`

## 実装済みコンポーネント一覧
- `App.tsx`: メインアプリケーション（モード管理、ポイント操作ロジック、並び替え機能）
- `Sidebar.tsx`: モード切り替えと機能ボタン、ポイント一覧表示（並び替えボタン付き）
- `PointEditModal.tsx`: ポイント編集モーダル（種別・コメント編集）
- `MapClickHandler.tsx`: 地図クリックイベント処理（編集モード時のみ有効）
- `PointMarker.tsx`: 地図上のポイントマーカー（ドラッグ・クリック対応）
- `RouteLine.tsx`: 経路ライン表示
- `CoordinateDisplay.tsx`: 座標・ズーム表示
- `FitBounds.tsx`: 経路全体を画面に収める
- `MessageDisplay.tsx`: 画面中央上部のメッセージ表示
- `route-api.ts`: 経路保存・読み込みAPI呼び出し
